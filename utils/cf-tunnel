#!/usr/bin/env bash

set -euo pipefail

# ===================================
# GLOBAL CONFIGURATION
# ===================================
DEFAULT_CF_TOKEN="${CF_TOKEN:-}"

# ===================================
# UTILITIES
# ===================================

abort() {
    echo "ERROR: $1" >&2
    exit 1
}

info() {
    echo "INFO: $1"
}

success() {
    echo "SUCCESS: $1"
}

usage() {
    cat <<EOF
Usage: $(basename "$0") <command> [options]

Commands:
  install              Install and start the Cloudflare tunnel service
  uninstall            Uninstall the Cloudflare tunnel service
  help                 Show this help message

Options:
  --token <token>      Specify the Cloudflare API token (overrides CF_TOKEN env)

Examples:
  CF_TOKEN=xyz ./$(basename "$0") install
  ./$(basename "$0") uninstall --token xyz
EOF
    exit 1
}

require_cmd() {
    command -v "$1" >/dev/null 2>&1 || abort "'$1' is not installed or not in PATH."
}

# ===================================
# COMMANDS IMPLEMENTATION
# ===================================

install_tunnel() {
    local token="$1"
    info "Installing Cloudflare tunnel service..."
    sudo cloudflared service install "$token"
    success "Tunnel installed and started successfully."
}

uninstall_tunnel() {
    local token="$1"
    info "Uninstalling Cloudflare tunnel service..."
    sudo cloudflared service uninstall "$token"
    success "Tunnel uninstalled successfully."
}

# ===================================
# MAIN CLI PARSER
# ===================================

main() {
    local cmd="${1:-}"
    shift || true

    local token="$DEFAULT_CF_TOKEN"

    # Parse global flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
        --token)
            token="$2"
            shift 2
            ;;
        --help | -h)
            usage
            ;;
        *)
            abort "Unknown option: $1"
            ;;
        esac
    done

    [[ -z "$cmd" ]] && usage
    [[ -z "$token" ]] && abort "Cloudflare API token is required (use --token or CF_TOKEN env)"

    require_cmd cloudflared

    case "$cmd" in
    install)
        install_tunnel "$token"
        ;;
    uninstall)
        uninstall_tunnel "$token"
        ;;
    help | --help | -h)
        usage
        ;;
    *)
        abort "Unknown command: $cmd"
        ;;
    esac
}

main "$@"
