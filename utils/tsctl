#!/usr/bin/env bash

set -euo pipefail

# -------------------------
# Defaults
# -------------------------
TAILSCALE_CMD="tailscale"
TAILSCALED_CMD="tailscaled"
RESOLV_CONF="/etc/resolv.conf"
NETWORK_MANAGER_SERVICE="NetworkManager"

# -------------------------
# Helper Functions
# -------------------------
function usage() {
    cat <<EOF
Usage: $(basename "$0") [command]

Commands:
  status              Show Tailscale status
  up                  Bring Tailscale up
  down                Bring Tailscale down and clean routes/DNS
  funnels             List active Funnels
  serves              List active Serve configurations
  help                Show this help message

Examples:
  $0 status
  $0 up
  $0 down
EOF
}

function require_cmd() {
    command -v "$1" >/dev/null 2>&1 || {
        echo "‚ùå '$1' is not installed."
        exit 1
    }
}

function clean_dns_routes() {
    echo "üßπ Cleaning routes and DNS..."

    echo "üìù Forcing DNS overwrite in $RESOLV_CONF..."
    sudo bash -c "cat > $RESOLV_CONF <<'EOF'
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run \"resolvectl status\" to see details about the actual nameservers.
nameserver 1.1.1.1
nameserver 1.0.0.1
EOF"

    echo "‚úÖ Cleanup done."
}

function setup_tailscale_dns() {
    echo "üîß Setting up Tailscale DNS..."

    # Force tailscale to regenerate DNS settings
    echo "üìù Forcing DNS overwrite in $RESOLV_CONF..."
    sudo bash -c "cat > $RESOLV_CONF <<'EOF'
# resolv.conf(5) file generated by tailscale
# For more info, see https://tailscale.com/s/resolvconf-overwrite
# DO NOT EDIT THIS FILE BY HAND -- CHANGES WILL BE OVERWRITTEN
nameserver 100.100.100.100
search tail0518ca.ts.net
EOF"

    echo "‚úÖ Tailscale DNS setup done."
}

# -------------------------
# Commands
# -------------------------
function cmd_status() {
    sudo $TAILSCALE_CMD status
}

function cmd_up() {
    sudo $TAILSCALE_CMD up
    setup_tailscale_dns
}

function cmd_down() {
    sudo $TAILSCALED_CMD --cleanup >/dev/null 2>&1 || echo "‚ÑπÔ∏è Tailscaled cleanup done."
    sudo $TAILSCALE_CMD down >/dev/null 2>&1 || echo "‚ÑπÔ∏è Tailscale was already down."
    clean_dns_routes
}

function cmd_funnels() {
    echo "üìã Listing active Funnels:"
    sudo $TAILSCALE_CMD funnel list || echo "No Funnels found."
}

function cmd_serves() {
    echo "üìã Listing active Serve configurations:"
    sudo $TAILSCALE_CMD serve status || echo "No Serve configurations found."
}

# -------------------------
# Main
# -------------------------
require_cmd "ip"

COMMAND="${1:-help}"

case "$COMMAND" in
status) cmd_status ;;
up) cmd_up ;;
down) cmd_down ;;
funnels) cmd_funnels ;;
serves) cmd_serves ;;
help | *) usage ;;
esac
